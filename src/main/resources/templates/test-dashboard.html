<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lab 14: Final Exam Dashboard</title>
</head>
<body>

<div class="container">
    <header>
        <h1>üéì Lab 14: Self-Check Worksheet Demo</h1>
        <div id="auth-status" class="status-out">‚ùå Not Logged In</div>
    </header>

    <div class="grid">

        <div class="card c-auth">
            <h2>üîê Authentication <span class="badge">Items 14-32</span></h2>
            <form id="authForm">
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                    <div>
                        <label>Username:</label>
                        <input type="text" name="username" value="user1" required>
                    </div>
                    <div>
                        <label>Email:</label>
                        <input type="email" name="email" value="user1@test.com" required>
                    </div>
                </div>
                <label>Password:</label>
                <input type="password" name="password" value="Pass123!" required>

                <div class="btn-group">
                    <button type="button" onclick="doRegister()" class="btn-green">1. Register</button>
                    <button type="button" onclick="doLogin()" class="btn-blue">2. Login</button>
                </div>
                <div class="btn-group">
                    <button type="button" onclick="doLogout()" class="btn-red">Logout</button>
                </div>
                <p style="font-size:0.8em; color:#666; margin-top:10px;">
                    * Try empty fields to show <strong>Validation (Item 53)</strong><br>
                    * Use "Network Tab" to show <strong>Headers (Item 58)</strong>
                </p>
            </form>
        </div>

        <div class="card c-data">
            <h2>üõ°Ô∏è Authorization & Isolation <span class="badge">Items 40-49</span></h2>
            <p style="font-size:0.85em; color:#64748b;">Prove that User B cannot see User A's data.</p>

            <label>1. Create a Private Note (User A):</label>
            <div style="display:flex; gap:5px;">
                <input type="text" id="noteTitle" placeholder="My Secret Note" value="Secret Note">
                <button onclick="createNote()" class="btn-green" style="flex:0 0 80px;">Save</button>
            </div>

            <label>2. View My Notes:</label>
            <button onclick="getMyNotes()" class="btn-blue">Get My Notes</button>

            <label>3. Attack (Try to see all notes):</label>
            <button onclick="testAttack()" class="btn-red">‚ö†Ô∏è Try Access Admin/Other Data</button>
        </div>

        <div class="card c-util">
            <h2>üîÑ Token Management <span class="badge">Items 79-81</span></h2>
            <p style="font-size:0.85em; color:#64748b;">Show Refresh Token Rotation live.</p>

            <label>Current Access Token (Snippet):</label>
            <input type="text" id="tokenSnippet" readonly style="background:#e2e8f0; color:#666;">

            <div class="btn-group">
                <button onclick="doRefreshToken()" class="btn-orange">üîÑ Refresh Token</button>
            </div>
            <p style="font-size:0.8em; color:#666; margin-top:5px;">Check console to see new token.</p>
        </div>

        <div class="card c-sec">
            <h2>üß™ Testing & CI/CD <span class="badge">Items 94-111</span></h2>
            <ul style="font-size:0.85em; padding-left:20px; color:#334155;">
                <li><strong>Unit Tests:</strong> Run <code>./gradlew test</code> in terminal.</li>
                <li><strong>Dependency Check:</strong> Show HTML report artifact.</li>
                <li><strong>Secure Access:</strong> Test <code>/api/demo-controller</code></li>
            </ul>
            <button onclick="testDemo()" class="btn-gray">Test Secure Endpoint</button>
        </div>

    </div>

    <div id="console-wrapper">
        <div style="display:flex; justify-content:space-between;">
            <strong>üñ•Ô∏è Live Verification Console</strong>
            <button onclick="document.getElementById('console-out').innerHTML=''" style="width:auto; padding:2px 8px; font-size:0.7em; background:#334155;">Clear</button>
        </div>
        <div id="console-out">Waiting for actions...</div>
    </div>
</div>

<script>
    // --- API CONFIGURATION ---
    const API = {
        register: '/api/auth/register',
        login:    '/api/auth/login',
        refresh:  '/api/auth/refresh',
        demo:     '/api/demo-controller',
        notes:    '/api/notes' // NoteController'ƒ±n varsa burayƒ± kullanƒ±r
    };

    let state = {
        accessToken: localStorage.getItem('access_token'),
        refreshToken: localStorage.getItem('refresh_token')
    };

    updateUI();

    // --- 1. AUTH ACTIONS ---
    async function doRegister() {
        const form = document.getElementById('authForm');
        const data = {
            username: form.username.value,
            email: form.email.value,
            password: form.password.value
        };
        log(`üîµ Registering user: ${data.username}...`);

        try {
            const res = await fetch(API.register, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            await handleResponse(res, "Register");
        } catch(e) { logError(e); }
    }

    async function doLogin() {
        const form = document.getElementById('authForm');
        const data = {
            username: form.username.value,
            password: form.password.value
        };
        log(`üîµ Logging in as: ${data.username}...`);

        try {
            const res = await fetch(API.login, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            const json = await handleResponse(res, "Login");
            if (res.ok) {
                // AuthResponse yapƒ±sƒ±na g√∂re token'ƒ± al
                const access = json.accessToken || json.access_token || json.token;
                const refresh = json.refreshToken || json.refresh_token;

                if(access) saveTokens(access, refresh);
            }
        } catch(e) { logError(e); }
    }

    function doLogout() {
        localStorage.clear();
        state.accessToken = null;
        state.refreshToken = null;
        updateUI();
        log("üö™ Logged out. Tokens cleared.", "info");
    }

    // --- 2. REFRESH TOKEN ACTION (Worksheet Item 80) ---
    async function doRefreshToken() {
        if(!state.refreshToken) {
            log("‚ö†Ô∏è No Refresh Token found! Login first.", "err");
            return;
        }
        log("üîÑ Requesting new Access Token...", "info");

        try {
            const res = await fetch(API.refresh, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ refreshToken: state.refreshToken })
            });

            const json = await handleResponse(res, "Refresh Token");
            if(res.ok) {
                const newAccess = json.accessToken || json.access_token;
                const newRefresh = json.refreshToken || json.refresh_token;
                saveTokens(newAccess, newRefresh || state.refreshToken);
            }
        } catch(e) { logError(e); }
    }

    // --- 3. DATA ISOLATION ACTIONS (Worksheet Item 40-49) ---
    async function createNote() {
        const title = document.getElementById('noteTitle').value;
        await secureRequest(API.notes, 'POST', { title: title, content: "Test content" });
    }

    async function getMyNotes() {
        log("üõ°Ô∏è Fetching MY notes (Should see data)...");
        await secureRequest(API.notes, 'GET');
    }

    async function testAttack() {
        log("‚öîÔ∏è Simulating Attack: Trying to access protected demo...", "info");
        // Eƒüer DemoController'ƒ± yetkilendirdiyseniz bu √ßalƒ±≈üƒ±r, yetkisiz ise 403 d√∂ner
        await secureRequest(API.demo, 'GET');
    }

    async function testDemo() {
        await secureRequest(API.demo, 'GET');
    }

    // --- HELPERS ---
    async function secureRequest(url, method, body = null) {
        if(!state.accessToken) {
            log("‚õî Not Logged In! Cannot perform secure action.", "err");
            return;
        }

        const options = {
            method: method,
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + state.accessToken
            }
        };
        if(body) options.body = JSON.stringify(body);

        try {
            const res = await fetch(url, options);
            await handleResponse(res, `${method} ${url}`);
        } catch(e) { logError(e); }
    }

    async function handleResponse(res, context) {
        const text = await res.text();
        let json = {};
        try { json = JSON.parse(text); } catch(e) { json = { msg: text }; }

        if(res.ok) {
            log(`‚úÖ ${context}: Success!`, "suc");
            log(`   Response: ${JSON.stringify(json).substring(0, 100)}...`, "info");
        } else {
            log(`‚ùå ${context}: Failed (${res.status})`, "err");
            log(`   Error: ${JSON.stringify(json)}`, "err");
        }
        return json;
    }

    function saveTokens(access, refresh) {
        state.accessToken = access;
        state.refreshToken = refresh;
        localStorage.setItem('access_token', access);
        localStorage.setItem('refresh_token', refresh);
        updateUI();
        log("üíæ Tokens saved to LocalStorage.", "suc");
    }

    function updateUI() {
        const statusEl = document.getElementById('auth-status');
        const tokenInp = document.getElementById('tokenSnippet');

        if(state.accessToken) {
            statusEl.innerText = "‚úÖ Logged In";
            statusEl.className = "status-in";
            tokenInp.value = state.accessToken.substring(0, 20) + "...";
        } else {
            statusEl.innerText = "‚ùå Not Logged In";
            statusEl.className = "status-out";
            tokenInp.value = "";
        }
    }

    function log(msg, type="info") {
        const out = document.getElementById('console-out');
        const time = new Date().toLocaleTimeString();
        out.innerHTML = `<div class="log-row ${'log-'+type}"><span class="log-time">[${time}]</span>${msg}</div>` + out.innerHTML;
    }
    function logError(e) { log("üí• Exception: " + e.message, "err"); }
</script>

</body>
</html>